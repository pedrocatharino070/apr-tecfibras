<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APR - TecFibras TELECOM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #eee; }
        .form-container { background-color: #fff; padding: 25px; border-radius: 5px; }
        h1, h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; color: #333; }
        label, .checkbox-title { display: block; margin-top: 15px; font-weight: bold; }
        input, textarea, select { width: 95%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        #gerarPDF { width: 100%; background-color: #c00; font-size: 18px; padding: 15px; margin-top: 20px; }
        .image-preview { max-width: 200px; margin-top: 10px; border: 1px solid #ddd; }
        #signature-pad-container { border: 1px solid #ccc; margin-top: 10px; border-radius: 4px; }
        .location-wrapper { display: flex; align-items: center; gap: 10px; }
        .location-wrapper input { flex-grow: 1; }
        .checkbox-group div { margin-top: 5px; }
        .checkbox-group label { font-weight: normal; display: inline; margin-left: 8px; }
    </style>
</head>
<body>

    <div class="form-container">
        <img src="LOGO TECFIBRASa.jpg" alt="Logo TecFibras" width="300" style="display: block; margin: auto;">
        <h1>Formulário de APR</h1>
        
        <form id="aprForm" onsubmit="return false;">
            <h2>1. DADOS DO SERVIÇO E EQUIPE</h2>
            <label for="os">Ordem de Serviço (OS):</label>
            <input type="text" id="os" name="os" required>
            
            <label for="tecnico">Técnico Responsável:</label>
            <input type="text" id="tecnico" name="tecnico" required>
            
            <label for="auxiliar">Auxiliar na Atividade (se houver):</label>
            <input type="text" id="auxiliar" name="auxiliar">

            <label for="descricao">Descrição Detalhada da Tarefa:</label>
            <input type="text" id="descricao" name="descricao">

            <label for="endereco">Endereço do Local:</label>
             <div class="location-wrapper">
                <input type="text" id="endereco" name="endereco" required placeholder="Preencha ou use o GPS">
                <button type="button" id="getLocationBtn">Usar GPS</button>
            </div>

            <h2>2. REGISTROS FOTOGRÁFICOS</h2>
            <label for="fotoLocal">Foto do Local:</label>
            <input type="file" id="fotoLocal" name="fotoLocal" accept="image/*" capture required>
            <img id="previewLocal" class="image-preview" alt="Preview">
             
            <label for="fotoEquipe">Foto da Equipe:</label>
            <input type="file" id="fotoEquipe" name="fotoEquipe" accept="image/*" capture required>
            <img id="previewEquipe" class="image-preview" alt="Preview">

            <h2>3. ANÁLISE DE RISCOS</h2>
            <div class="checkbox-group" id="riscos-group">
                <span class="checkbox-title">(Marcar os riscos identificados)</span>
                <div><input type="checkbox" id="risco1" name="riscos"><label for="risco1">Queda de altura acima de 2m (NR-35)</label></div>
                <div><input type="checkbox" id="risco2" name="riscos"><label for="risco2">Esforço físico</label></div>
                <div><input type="checkbox" id="risco3" name="riscos"><label for="risco3">Postura inadequada</label></div>
                <div><input type="checkbox" id="risco4" name="riscos"><label for="risco4">Choque elétrico (NR-10)</label></div>
                <div><input type="checkbox" id="risco5" name="riscos"><label for="risco5">Espaço confinado (NR-33)</label></div>
            </div>
            
            <h2>4. EQUIPAMENTOS (CHECKLIST)</h2>
            <div class="checkbox-group" id="epis-group">
                <span class="checkbox-title">(Marcar itens em posse)</span>
                <div><input type="checkbox" id="epi1"><label for="epi1">Anel de Ancoragem 1,5m</label></div>
                <div><input type="checkbox" id="epi2"><label for="epi2">Anel de Ancoragem 2m</label></div>
                <div><input type="checkbox" id="epi3"><label for="epi3">Botina de Segurança</label></div>
                <div><input type="checkbox" id="epi4"><label for="epi4">Calça</label></div>
                <div><input type="checkbox" id="epi5"><label for="epi5">Camiseta</label></div>
                <div><input type="checkbox" id="epi6"><label for="epi6">Caneta de Teste de Tensão 1000V</label></div>
                <div><input type="checkbox" id="epi7"><label for="epi7">Capacete Aba Total com Jugular</label></div>
                <div><input type="checkbox" id="epi8"><label for="epi8">Cinto Tipo Paraquedista 5 ou 6 Pontas</label></div>
                <div><input type="checkbox" id="epi9"><label for="epi9">Corda 12mm 20m</label></div>
                <div><input type="checkbox" id="epi10"><label for="epi10">Fita Catraca</label></div>
                <div><input type="checkbox" id="epi11"><label for="epi11">Fita Eureka de Ancoragem com ABS</label></div>
                <div><input type="checkbox" id="epi12"><label for="epi12">Freio ABS Descensor</label></div>
                <div><input type="checkbox" id="epi13"><label for="epi13">Luva de Vaqueta</label></div>
                <div><input type="checkbox" id="epi14"><label for="epi14">Mosquetão Oval</label></div>
                <div><input type="checkbox" id="epi15"><label for="epi15">Óculos Fumê de Proteção</label></div>
                <div><input type="checkbox" id="epi16"><label for="epi16">Óculos Incolor de Proteção</label></div>
                <div><input type="checkbox" id="epi17"><label for="epi17">Talabarte de Posicionamento</label></div>
                <div><input type="checkbox" id="epi18"><label for="epi18">Trava Queda 12mm</label></div>
            </div>

            <h2>5. ASSINATURA</h2>
            <label for="assinatura-canvas">Assine no quadro abaixo:</label>
            <div id="signature-pad-container">
                <canvas id="signature-pad" width="300" height="150"></canvas>
            </div>
            <button type="button" id="clear-signature">Limpar</button>
        </form>
    </div>

    <button id="gerarPDF">Gerar APR em PDF</button>

    <script>
        window.jsPDF = window.jspdf.jsPDF;

        // --- INICIALIZAÇÃO DO PAD DE ASSINATURA ---
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
        document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());

        // --- FUNÇÃO PARA PREVIEW DAS FOTOS ---
        function setupImagePreview(inputId, previewId) {
            document.getElementById(inputId).addEventListener('change', event => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => document.getElementById(previewId).src = e.target.result;
                    reader.readAsDataURL(file);
                }
            });
        }
        setupImagePreview('fotoLocal', 'previewLocal');
        setupImagePreview('fotoEquipe', 'previewEquipe');
        
        // --- FUNCIONALIDADE DO BOTÃO DE GPS ---
        document.getElementById('getLocationBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.textContent = 'Buscando...';
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=<span class="math-inline">\{latitude\}&lon\=</span>{longitude}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('endereco').value = data.display_name || "Endereço não encontrado.";
                            this.textContent = 'Usar GPS';
                        })
                        .catch(() => {
                            alert('Não foi possível obter o nome do endereço. Preencha manualmente.');
                            this.textContent = 'Usar GPS';
                        });
                }, () => {
                    alert('Não foi possível obter a localização. Verifique as permissões do navegador.');
                    this.textContent = 'Usar GPS';
                });
            } else {
                alert('Geolocalização não é suportada por este navegador.');
            }
        });

        // --- FUNÇÃO PRINCIPAL PARA GERAR O PDF ---
        document.getElementById('gerarPDF').addEventListener('click', function () {
            if (signaturePad.isEmpty() || !document.getElementById('aprForm').checkValidity()) {
                alert('Por favor, preencha todos os campos obrigatórios e a assinatura.');
                return;
            }

            const pdf = new jsPDF('p', 'mm', 'a4');
            const page_width = pdf.internal.pageSize.getWidth();
            let y = 15; // Posição vertical inicial

            // --- CABEÇALHO ---
            pdf.setFontSize(16);
            pdf.setFont("helvetica", "bold");
            pdf.text("ANÁLISE PRELIMINAR DE RISCO (APR)", page_width / 2, y, { align: 'center' });
            y += 10;
            
            // --- DADOS DO SERVIÇO ---
            pdf.setFontSize(10);
            pdf.text("OS:", 15, y);
            pdf.setFont("helvetica", "normal");
            pdf.text(document.getElementById('os').value, 45, y);
            
            const hoje = new Date();
            pdf.setFont("helvetica", "bold");
            pdf.text("Data de Emissão:", 110, y);
            pdf.setFont("helvetica", "normal");
            pdf.text(hoje.toLocaleDateString(), 145, y);
            y += 7;

            pdf.setFont("helvetica", "bold");
            pdf.text("Equipe:", 15, y);
            pdf.setFont("helvetica", "normal");
            pdf.text(document.getElementById('tecnico').value, 45, y);
            y += 7;

            pdf.setFont("helvetica", "bold");
            pdf.text("Local:", 15, y);
            pdf.setFont("helvetica", "normal");
            pdf.text(document.getElementById('endereco').value, 45, y, { maxWidth: 140 });
            y += 15;
            
            // --- FOTOS ---
            const imgLocal = document.getElementById('previewLocal');
            if (imgLocal.src) {
                 pdf.addImage(imgLocal.src, 'PNG', 15, y, 80, 50);
            }

            const mapImage = 'https://i.imgur.com/gCCznJc.png'; // Placeholder do mapa
            pdf.addImage(mapImage, 'PNG', 110, y, 80, 50);
            y += 55;
            
            // --- RISCOS MARCADOS ---
            y = addCheckboxSectionToPdf(pdf, "Riscos Associados à Tarefa:", "#riscos-group", y);
            
            // --- EQUIPAMENTOS MARCADOS ---
            y = addCheckboxSectionToPdf(pdf, "Itens Necessários para a Atividade:", "#epis-group", y);

            // --- ASSINATURA ---
            pdf.setFont("helvetica", "bold");
            pdf.text("Assinatura do Técnico:", 15, y);
            const signatureImage = signaturePad.toDataURL();
            pdf.addImage(signatureImage, 'PNG', 15, y + 2, 60, 30);
            
            pdf.setFontSize(8);
            pdf.text(`Gerado em: ${hoje.toLocaleDateString()} às ${hoje.toLocaleTimeString()}`, 15, y + 38);

            // --- SALVAR O PDF ---
            const os_val = document.getElementById('os').value || '0000';
