<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APR - TecFibras TELECOM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #eee; }
        #apr-content { background-color: #fff; padding: 25px; border-radius: 5px; }
        .form-section { padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; }
        h1, h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; color: #333; }
        h1 { text-align: center; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, textarea, select { width: 95%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .checkbox-group label { font-weight: normal; display: inline; margin-left: 5px;}
        button { display: inline-block; background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; margin-top: 10px; }
        #gerarPDF { width: 100%; background-color: #c00; font-size: 18px; padding: 15px; }
        img.logo { display: block; margin: 0 auto 20px auto; }
        .location-wrapper { display: flex; align-items: center; }
        .location-wrapper input { flex-grow: 1; }
        .location-wrapper button { margin-left: 10px; flex-shrink: 0; }
    </style>
</head>
<body>

    <div id="apr-content">
        <img src="LOGO TECFIBRASa.jpg" alt="Logo TecFibras" width="300" class="logo">
        
        <h1>ANÁLISE PRELIMINAR DE RISCO (APR)</h1>
        
        <form id="aprForm" onsubmit="return false;">
            <div class="form-section">
                <h2>1. DADOS DO SERVIÇO E EQUIPE</h2>
                <label for="dataEmissao">Data da Emissão:</label>
                <input type="date" id="dataEmissao" name="dataEmissao" required>

                <label for="os">Ordem de Serviço (OS):</label>
                <input type="text" id="os" name="os" required>
                
                <label for="endereco">Endereço do Local:</label>
                <div class="location-wrapper">
                    <input type="text" id="endereco" name="endereco" required placeholder="Clique no botão para preencher...">
                    <button type="button" id="getLocationBtn">Usar GPS</button>
                </div>
            </div>

            <div class="form-section">
                 <h2>2. REGISTROS FOTOGRÁFICOS</h2>
                 <p>Obs: As fotos não aparecerão no PDF gerado. Devem ser enviadas separadamente.</p>
                 <label for="fotoLocal">Foto da Fachada (abre a câmera):</label>
                 <input type="file" id="fotoLocal" name="fotoLocal" accept="image/*" capture>
                 
                 <label for="fotoEquipe">Foto da Equipe (abre a câmera):</label>
                 <input type="file" id="fotoEquipe" name="fotoEquipe" accept="image/*" capture>
            </div>

            <div class="form-section">
                <h2>6. APROVAÇÃO E ASSINATURA</h2>
                <label for="assinaturaNome">Confirmado por (Técnico Responsável):</label>
                <input type="text" id="assinaturaNome" name="assinaturaNome" placeholder="Digite seu nome completo aqui" required>
                <div class="checkbox-group">
                    <input type="checkbox" id="aceite" name="aceite" required>
                    <label for="aceite">Confirmo que as informações são verdadeiras e assino eletronicamente este documento.</label>
                </div>
            </div>
        </form>
    </div>

    <button id="gerarPDF">Gerar APR em PDF</button>

    <script>
        window.jsPDF = window.jspdf.jsPDF;

        // --- FUNCIONALIDADE DO BOTÃO DE GPS ---
        document.getElementById('getLocationBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.textContent = 'Aguarde...';
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    // Usando uma API gratuita para converter coordenadas em endereço
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('endereco').value = data.display_name;
                            document.getElementById('getLocationBtn').textContent = 'Usar GPS';
                        })
                        .catch(error => {
                            alert('Não foi possível obter o endereço. Preencha manualmente.');
                            console.error('Erro na API de geolocalização:', error);
                            document.getElementById('getLocationBtn').textContent = 'Usar GPS';
                        });
                }, function(error) {
                    alert('Não foi possível obter a localização. Verifique as permissões do navegador.');
                    console.error('Erro de geolocalização:', error);
                    document.getElementById('getLocationBtn').textContent = 'Usar GPS';
                });
            } else {
                alert('Geolocalização não é suportada por este navegador.');
            }
        });

        // --- FUNCIONALIDADE PARA GERAR O PDF ---
        document.getElementById('gerarPDF').addEventListener('click', function () {
            // Validação simples para ver se os campos obrigatórios estão preenchidos
            if (!document.getElementById('aprForm').checkValidity()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de gerar o PDF.');
                return;
            }

            const tecnico = document.getElementById('assinaturaNome').value || 'tecnico';
            const os = document.getElementById('os').value || '0000';
            const nomeArquivo = `APR_${os}_${tecnico.replace(/ /g, '_')}.pdf`;

            const content = document.getElementById('apr-content');
            
            html2canvas(content, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(nomeArquivo);
            });
        });
    </script>
</body>
</html>
