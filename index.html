<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APR - TecFibras TELECOM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #eee; }
        #apr-content { background-color: #fff; padding: 25px; border-radius: 5px; }
        .form-section { padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; }
        h1 { text-align: center; }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; color: #333; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 95%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .checkbox-group label { font-weight: normal; display: block; }
        button { display: block; width: 100%; background-color: #c00; color: white; padding: 15px 20px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 20px; }
        button:hover { background-color: #a00; }
        img.logo { display: block; margin: 0 auto 20px auto; }
    </style>
</head>
<body>

    <div id="apr-content">
        <img src="https://i.ibb.co/L9Y00k2/LOGO-TECFIBRASa.jpg" alt="Logo TecFibras" width="300" class="logo">
        <h1>ANÁLISE PRELIMINAR DE RISCO (APR)</h1>
        
        <form id="aprForm">
            <div class="form-section">
                <h2>1. DADOS DO SERVIÇO E EQUIPE</h2>
                <label for="dataEmissao">Data da Emissão:</label>
                <input type="date" id="dataEmissao" name="dataEmissao" required>

                <label for="os">Ordem de Serviço (OS):</label>
                <input type="text" id="os" name="os" required>

                <label for="contrato">Obra / Contrato:</label>
                <select id="contrato" name="contrato" required>
                    <option value="">-- Selecione --</option>
                    <option value="Brasil TecPar">Brasil TecPar</option>
                    <option value="Cuiabá Fibra">Cuiabá Fibra</option>
                </select>

                <label for="tecnico">Técnico Responsável:</label>
                <input type="text" id="tecnico" name="tecnico" required>

                <label for="auxiliar">Auxiliar na Atividade (se houver):</label>
                <input type="text" id="auxiliar" name="auxiliar">
                
                <label for="descricao">Descrição Detalhada da Tarefa:</label>
                <textarea id="descricao" name="descricao" rows="3"></textarea>
                
                <label for="endereco">Endereço do Local:</label>
                <input type="text" id="endereco" name="endereco" required>
                 
                <label for="checkin">Data e Hora do Check-in:</label>
                <input type="time" id="checkin" name="checkin" required>
            </div>

            <div class="form-section">
                 <h2>2. REGISTROS FOTOGRÁFICOS</h2>
                 <p>Obs: As fotos não aparecerão no PDF gerado. Devem ser enviadas separadamente.</p>
                 <label for="fotoLocal">Foto da Fachada/Frente do Local:</label>
                 <input type="file" id="fotoLocal" name="fotoLocal" accept="image/*">
                 
                 <label for="fotoEquipe">Foto da Equipe Uniformizada no Local:</label>
                 <input type="file" id="fotoEquipe" name="fotoEquipe" accept="image/*">
            </div>

            <div class="form-section">
                <h2>3. ANÁLISE DE RISCOS</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="risco1" name="risco" value="Queda"><label for="risco1"> Queda de altura acima de 2m (NR-35)</label><br>
                    <input type="checkbox" id="risco2" name="risco" value="Choque"><label for="risco2"> Choque elétrico (NR-10)</label><br>
                    <input type="checkbox" id="risco3" name="risco" value="Esforco"><label for="risco3"> Esforço físico</label><br>
                    <input type="checkbox" id="risco4" name="risco" value="Postura"><label for="risco4"> Postura inadequada</label><br>
                    <input type="checkbox" id="risco5" name="risco" value="Confinado"><label for="risco5"> Espaço confinado (NR-33)</label><br>
                </div>
            </div>

            <div class="form-section">
                <h2>4. EQUIPAMENTOS DE PROTEÇÃO (CHECKLIST)</h2>
                 <div class="checkbox-group">
                    <input type="checkbox" id="epi1" name="epi" value="Botina"><label for="epi1"> Botina de Segurança</label><br>
                    <input type="checkbox" id="epi2" name="epi" value="Capacete"><label for="epi2"> Capacete Aba Total com Jugular</label><br>
                    <input type="checkbox" id="epi3" name="epi" value="Cinto"><label for="epi3"> Cinto Tipo Paraquedista 5 ou 6 Pontas</label><br>
                 </div>
            </div>

             <div class="form-section">
                <h2>5. DECLARAÇÃO DE CONFORMIDADE</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="conf1" name="conf" required><label for="conf1"> Afirmo que toda equipe está de posse de todos os EPI/EPC necessários.</label><br>
                    <input type="checkbox" id="conf2" name="conf" required><label for="conf2"> Confirmo que todos os membros da equipe estão capacitados e em boas condições de saúde.</label><br>
                </div>
            </div>
        </form>
    </div>

    <button id="gerarPDF">Gerar APR em PDF</button>

    <script>
        // Adicionando a funcionalidade ao botão
        document.getElementById('gerarPDF').addEventListener('click', function () {
            // Pega o nome do técnico e o número da OS para o nome do arquivo
            const tecnico = document.getElementById('tecnico').value || 'tecnico';
            const os = document.getElementById('os').value || '0000';
            const nomeArquivo = `APR_${os}_${tecnico.replace(/ /g, '_')}.pdf`;

            // Elemento que será convertido em PDF
            const content = document.getElementById('apr-content');
            
            // Opções para a geração da imagem
            const options = {
                scale: 2, // Melhora a qualidade da imagem
                logging: true,
                useCORS: true
            };

            // Usa html2canvas para "fotografar" o conteúdo
            html2canvas(content, options).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                
                // Inicializa o jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                // Calcula as dimensões para a imagem caber na página A4
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                // Adiciona a imagem ao PDF e salva
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(nomeArquivo);
            });
        });
    </script>
</body>
</html>
