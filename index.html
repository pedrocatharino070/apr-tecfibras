<script>
    document.addEventListener('DOMContentLoaded', function() {
        window.jsPDF = window.jspdf.jsPDF;
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

        // --- Event listeners dos checkboxes e geolocalização (código original, sem alterações) ---
        document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());
        document.getElementById('selectAllEpis').addEventListener('change', (e) => {
            document.querySelectorAll('.epi-item').forEach(c => c.checked = e.target.checked);
        });
        document.getElementById('selectAllRisksField').addEventListener('change', (e) => {
            document.querySelectorAll('.risco-item').forEach(c => c.checked = e.target.checked);
        });
        document.getElementById('selectRisksCondo').addEventListener('change', (e) => {
            const targets = ['Cortes e perfurações', 'Queda de objetos', 'Postura inadequada'];
            document.querySelectorAll('.risco-item').forEach(c => {
                if (targets.includes(c.nextElementSibling.textContent.trim())) {
                    c.checked = e.target.checked;
                }
            });
        });
        document.getElementById('getLocation').addEventListener('click', () => {
            const enderecoInput = document.getElementById('endereco');
            if (!navigator.geolocation) {
                alert("Geolocalização não é suportada por este navegador.");
                return;
            }
            enderecoInput.value = "Obtendo localização...";
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const geocoder = new google.maps.Geocoder();
                    const latlng = { lat: position.coords.latitude, lng: position.coords.longitude };
                    geocoder.geocode({ location: latlng }, (results, status) => {
                        if (status === "OK" && results[0]) {
                            enderecoInput.value = results[0].formatted_address;
                        } else {
                            enderecoInput.value = "Erro ao buscar endereço: " + status;
                        }
                    });
                }, (error) => {
                    enderecoInput.value = "Não foi possível obter a localização.";
                    alert(`ERRO(${error.code}): ${error.message}`);
                }
            );
        });

        // --- Função de preview de imagem (código original, sem alterações) ---
        function setupImagePreview(inputId, previewId) {
            document.getElementById(inputId).addEventListener('change', event => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    const preview = document.getElementById(previewId);
                    reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
                    reader.readAsDataURL(file);
                }
            });
        }
        setupImagePreview('fotoLocal', 'previewLocal');
        setupImagePreview('fotoEquipe', 'previewEquipe');

        // ===================================================================
        // INÍCIO DAS MODIFICAÇÕES
        // ===================================================================

        /**
         * NOVA FUNÇÃO: Processa uma imagem para redimensionar e comprimir.
         * @param {string} previewId - ID do elemento <img> com o preview.
         * @param {number} maxWidth - Largura máxima em pixels.
         * @param {number} quality - Qualidade do JPEG (0.0 a 1.0).
         * @returns {Promise<string|null>} DataURL da imagem otimizada em JPEG.
         */
        function processImage(previewId, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const imgElement = document.getElementById(previewId);
                if (!imgElement || !imgElement.src.startsWith('data:image')) {
                    resolve(null);
                    return;
                }
                const originalImage = new Image();
                originalImage.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const aspectRatio = originalImage.height / originalImage.width;
                    const newWidth = Math.min(maxWidth, originalImage.width);
                    const newHeight = newWidth * aspectRatio;
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(originalImage, 0, 0, newWidth, newHeight);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                originalImage.onerror = () => resolve(null);
                originalImage.src = imgElement.src;
            });
        }

        // A função de clique do botão gerarPDF agora é 'async' para esperar as imagens
        document.getElementById('gerarPDF').addEventListener('click', async function() {

            const form = document.getElementById('aprForm');
            const pdfButton = this;

            if (signaturePad.isEmpty() || !form.checkValidity()) {
                alert('Preencha todos os campos obrigatórios e a assinatura.');
                // Força o navegador a mostrar quais campos faltam
                form.reportValidity();
                return;
            }

            // Desabilita o botão para evitar cliques duplos e dá feedback
            const originalButtonText = pdfButton.textContent;
            pdfButton.textContent = 'Gerando PDF, por favor aguarde...';
            pdfButton.disabled = true;

            try {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                const bottomMargin = 20;
                let y = margin;

                // --- Funções Auxiliares (mantidas dentro do escopo, como no original) ---

                function checkPageBreak(currentY, neededHeight = 10) {
                    if (currentY + neededHeight > pageHeight - bottomMargin) {
                        pdf.addPage();
                        return margin;
                    }
                    return currentY;
                }

                const hoje = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const protocolo = `${hoje.getFullYear()}${pad(hoje.getMonth() + 1)}${pad(hoje.getDate())}-${pad(hoje.getHours())}${pad(hoje.getMinutes())}${pad(hoje.getSeconds())}`;
                
                pdf.setFontSize(9).setFont(undefined, "normal").text(`Protocolo: ${protocolo}`, pageWidth - margin, margin, { align: 'right' });
                y += 10;
                
                const logo = document.querySelector('img[alt="Logo TecFibras"]');
                if (logo && logo.complete && logo.naturalHeight > 0) {
                    pdf.addImage(logo, 'JPEG', (pageWidth - 60) / 2, y, 60, 20);
                    y += 25;
                }
                
                y = checkPageBreak(y);
                pdf.setFontSize(16).setFont(undefined, "bold").text("ANÁLISE PRELIMINAR DE RISCO (APR)", pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                function addSectionTitle(title, startY) {
                    startY = checkPageBreak(startY, 15);
                    pdf.setFontSize(12).setFont(undefined, "bold").text(title, margin, startY);
                    pdf.line(margin, startY + 1, pageWidth - margin, startY + 1);
                    return startY + 8;
                }

                // FUNÇÃO addText CORRIGIDA para ter o espaçamento correto
                function addText(label, value, startY) {
                    startY = checkPageBreak(startY);
                    pdf.setFontSize(10).setFont(undefined, "bold").text(label, margin, startY);
                    
                    const splitText = pdf.splitTextToSize(value || "-", pageWidth - margin - 45);
                    pdf.setFont(undefined, "normal");
                    
                    // Loop para desenhar cada linha com espaçamento manual
                    splitText.forEach(line => {
                        pdf.text(line, margin + 40, startY);
                        startY += 5; // Espaçamento de 5mm por linha
                    });
                    
                    // Se não houver texto, avançamos um pouco mesmo assim
                    if (splitText.length === 0) {
                        startY += 5;
                    }
                    return startY;
                }

                function addList(items, startY) {
                    for (const item of items) {
                        startY = checkPageBreak(startY, 5);
                        pdf.setFontSize(9).setFont(undefined, "normal").text(`• ${item}`, margin, startY);
                        startY += 5;
                    }
                    return startY;
                }

                y = addSectionTitle("1. DADOS DO SERVIÇO", y);
                y = addText('Obra/Provedor:', document.getElementById('provedor').value, y);
                y = addText('Ordem de Serviço:', document.getElementById('os').value, y);
                y = addText('Técnico:', document.getElementById('tecnico').value, y);
                y = addText('Endereço:', document.getElementById('endereco').value, y);
                y = addText('Descrição:', document.getElementById('descricao').value, y);
                y += 5;
                
                // SEÇÃO DE IMAGENS MODIFICADA para usar a compressão
                y = addSectionTitle("2. REGISTROS FOTOGRÁFICOS", y);
                
                const fotoLocalProcessada = await processImage('previewLocal');
                if (fotoLocalProcessada) {
                    y = checkPageBreak(y, 55);
                    pdf.setFont(undefined, "bold").text('Foto do Local:', margin, y);
                    pdf.addImage(fotoLocalProcessada, 'JPEG', margin, y + 2, 80, 50);
                    y += 55;
                }
                
                const fotoEquipeProcessada = await processImage('previewEquipe');
                if (fotoEquipeProcessada) {
                    y = checkPageBreak(y, 55);
                    pdf.setFont(undefined, "bold").text('Foto da Equipe:', margin, y);
                    pdf.addImage(fotoEquipeProcessada, 'JPEG', margin, y + 2, 80, 50);
                    y += 55;
                }
                y += 5;

                // --- Seções de Riscos e Equipamentos (código original, sem alterações) ---
                y = addSectionTitle("3. ANÁLISE DE RISCOS", y);
                const riscos = Array.from(document.querySelectorAll('#riscos-group .risco-item:checked')).map(c => c.nextElementSibling.textContent.trim());
                y = addList(riscos, y);
                y += 5;

                y = addSectionTitle("4. EQUIPAMENTOS UTILIZADOS", y);
                const epis = Array.from(document.querySelectorAll('#epis-group .epi-item:checked')).map(c => c.nextElementSibling.textContent.trim());
                y = addList(epis, y);
                y += 5;
                
                // --- Seção de Declarações (código original, sem alterações) ---
                y = addSectionTitle("5. DECLARAÇÕES DE CIÊNCIA", y);
                if (document.getElementById('cienteEmergencia').checked) {
                    y = checkPageBreak(y, 20);
                    const text = document.getElementById('textoEmergencia').textContent.trim();
                    const splitText = pdf.splitTextToSize(text, pageWidth - (margin * 2));
                    pdf.setFontSize(9).setFont(undefined, "italic").text(splitText, margin, y);
                    y += (splitText.length * 4) + 2;
                    pdf.setFont(undefined, "bold").text("✅ CONFIRMADO PELO TÉCNICO.", margin, y);
                    y += 6;
                }
                if (document.getElementById('confirma1').checked) {
                    y = checkPageBreak(y, 25);
                    const text = document.getElementById('textoNR1').textContent.trim();
                    const splitText = pdf.splitTextToSize(text, pageWidth - (margin * 2));
                    pdf.setFontSize(9).setFont(undefined, "italic").text(splitText, margin, y);
                    y += (splitText.length * 4) + 2;
                    const labelText = document.querySelector('label[for="confirma1"]').textContent.trim();
                    pdf.setFont(undefined, "bold").text(`✅ ${labelText}`, margin, y);
                    y += 6;
                }

                // SEÇÃO DE ASSINATURA MODIFICADA para usar compressão
                y = addSectionTitle("6. ASSINATURA", y);
                y = checkPageBreak(y, 40);
                const signatureImage = signaturePad.toDataURL('image/jpeg', 0.8);
                pdf.addImage(signatureImage, 'JPEG', margin, y, 70, 30);
                pdf.setFontSize(9).setFont(undefined, "normal").text(`Assinado digitalmente por:`, margin + 80, y + 10);
                pdf.setFont(undefined, "bold").text(`${document.getElementById('tecnico').value}`, margin + 80, y + 15);
                pdf.setFont(undefined, "normal").text(`Data e Hora: ${hoje.toLocaleString('pt-BR')}`, margin + 80, y + 20);

                pdf.save(`APR_OS-${document.getElementById('os').value}_PROTOCOLO-${protocolo}.pdf`);

            } catch (error) {
                console.error("Ocorreu um erro ao gerar o PDF:", error);
                alert("Ocorreu um erro inesperado. Verifique o console para mais detalhes.");
            } finally {
                // Reabilita o botão, mesmo se ocorrer um erro
                pdfButton.textContent = originalButtonText;
                pdfButton.disabled = false;
            }
        });
    });
</script>
